\chapter{多视角人脸数据采集平台}
\label{chap:platform}

在上一章的最后，本文提到了若要解决从单张图像同时重建人脸3D模型的几何和材质细节这一高度非适定的问题，则需要更多有关人脸的先验知识。
现有方法通常通过大量高精度的3D数据以训练神经网络模型来建模这种先验。
这些高精度的数据有时候以启发式的算法从2D图像中生成，
但更加鲁棒和贴近物理的方法自然是使用高精度的设备直接采集获得。

然而，可用于实现人脸几何和材质细节高精度重建的设备通常价格高昂，其采集的数据往往也由于商业价值较高而不被公开。
因此，不论是采集高精度的数据以重建高精度模型直接用于下游任务，还是用于建立先验以实现更高效的3D人脸重建，都离不开一套精准、高效、可靠的采集平台。

本章将介绍一套在较为有限的经济和时间成本下实现的多视角人脸数据采集平台。
该平台尽量使用可在市面上购买的部件，以减少对相关专业知识的需求。
同时配合一些定制的软件和硬件，实现对各个部件的高效统筹控制，为高精度重建所需的数据采集全流程提供支持。

\section{总体目标}

本文在设计和搭建该采集平台时，主要考虑了以下几个目标：
\begin{itemize}
\item 低硬件专业技能需求。本项目作为软件学院个人参与的项目，其所能得到的机械、结构、电子等方面的专业技术支持非常有限。
因此，为了能在有限的时间内完成该项目，本文尽可能地使用市面上可购买的部件，以减少对相关专业知识的需求。
虽然如此，本文还是使用了少量定制的硬件。

\item 高精度。高精度的数据是高精度3D重建的基础。
因此，对误差的控制贯穿与采集流程的各个环节，指导整个采集平台的软硬件设计。

\item 高效。整个平台在使用时，特别是在对被拍摄对象拍照时，应该尽可能地快速，以为大规模收集数据集提供可能。

\item 灵活。本平台作为一个主要用于研究性工作的采集平台，其需要具有一定的灵活性，以便应对研究中多变的需求。
基本地，该平台应能同时支持被动光源和主动光源的采集，能灵活配置相机和光源的位置和其他相关参数。

\item 可扩展。即使在本文写作完成后，该平台仍很可能被继续用于后续的研究工作。因此本平台也应适当考虑未来可能的更大规模的采集需求。

\end{itemize}

利用本平台采集的数据预计可用于多种3D人脸重建算法，例如本文其他部分介绍的基于可微分渲染的逆渲染方法。
同时也可用于如多目立体等传统的计算机视觉算法。

本章的主要贡献在于对该平台各个部分的设计和实现，以及对其性能的评估验证。
本章的剩余内容将具体介绍该平台的各个部分。

\section{整体结构设计}

本平台的硬件框架结构设计主要是参考了\citet{RiviereGBGB20}所展示的布局。
首批配置了12台相机和4台带有柔光箱的摄影灯，其中相机固定在3个铝型材搭建的、定制的、高自由度可调节的支架上。
灯则由于其体积质量较大，且市面上缺少相应的单独连接件产品，无法稳固地固定在支架上，因此直接使用了单独的专用灯架固定，以确保安全。
图\ref{fig:HDRI}展示了该平台硬件的整体布局。

\begin{figure}
\centering
\begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[height=7cm]{figures/frame-design}
    \caption{设计图}
\end{subfigure}
\begin{subfigure}[b]{0.2\textwidth}
    \centering
    \includegraphics[height=7cm]{figures/frame-impl}
    \caption{组装完成照片}
\end{subfigure}
\begin{subfigure}[b]{0.47\textwidth}
    \centering
    \includegraphics[height=7cm]{figures/frame-camera}
    \caption{相机固定}
\end{subfigure}
\caption{铝型材支架的设计和实现}
\label{fig:frame}
\end{figure}

图\ref{fig:frame}展示了铝型材支架的设计和实现。
单个支架的主体部分由4个2寸脚轮，12.47米3030铝型材以及若干连接件组成。
设计全高2.103米，长1.06米，宽0.53米。
其物料成本约需要700元。
考虑到实验场地可能的变动，支架装配有4个脚轮，方便移动，且这些脚轮带有锁定功能，在使用时也能固定支架的位置。
脚轮固定在矩形底座上，底座则通过大量连接件，尽可能稳固地支撑了两根2米长的竖直铝型材。
在竖杆之间设计有4根长1米的横杆。
每两根间设计间距为0.5米，但得益于本方案使用T型螺母固定，无需打孔，因此这些横杆的位置可根据需要随时调整。

相机可固定在任意竖杆和横杆上的任意位置。
为固定相机，本方案首先将T型连接板通过T型螺母固定在铝型材上，然后将一个球形云台通过1/4英寸螺栓固定在连接板上，最后将相机通过标准的1/4英寸接口固定在云台上。
使用云台可允许相机以三个自由度任意旋转，再加上相机固定位置，横杆位置，以及支架整体的移动，相机最终固定位置的可调节自由度非常高。

总的来说，该支架支撑稳定，使用灵活，完全满足了固定12台相机的需求，为其他部分的实现打下了良好的基础。
同时，通过增加横杆，或增加支架数量的方式，也可以扩展更多相机固定位置。

\section{被动相机同步}
\label{sec:passive_sync}

本方案使用的是CVTE提供的12台消费级微单相机，型号为佳能R6。
将这些相机固定在支架上后，下一步就需要对它们集中进行控制。
其中最简单的形式就是使它们精确地在同一时刻触发快门，以确保后期重建过程不会受到被拍摄对象的位移或形变影响。
为此，本方案中设计了一种用于相机同步的硬件装置。
该装置构造简单，且无须独立供电。它能以很高的时间精度同时触发多台相机的对焦和快门，从而实现人脸多视角数据的捕获。

\paragraph{相机快门触发原理}

为设计该装置，本文首先调查了所使用的相机所有可能的快门触发方式，包括：
\begin{itemize}
\item 相机机身上的快门按钮。该按钮半按可触发对焦，全按可触发快门。
然而使用机械方式触发快门对自动化控制系统来说显然过于复杂，且容易造成不必要的机械震动。
\item 网络接口。该相机支持连接WiFi，并可通过佳能的私有协议或者基于HTTP的Camera Control API控制。
但是无线网络连接会引入毫秒级别的不确定性延迟，因此不适合用于本方案中高精度的同步控制。
\item 快门线接口。该相机支持通过2.5mm快门线接口触发快门，该接口仅需要简单地控制电路通断即可触发对焦和快门。
\item USB连接。该相机支持通过USB连接上游设备，且可通过佳能的私有协议控制。
该方案虽然可以实现更多控制功能，且USB还能直接为相机供电，
但相比上一种方案，上游设备的开发过于复杂，且佳能官方仅提供了Windows平台的SDK，更提高了开发难度。
\end{itemize}
基于这些考虑，本方案最终使用了快门线接口作为相机同步的触发方式。

用于快门线接口的2.5mm插头如图\ref{fig:2.5mm}所示。
该插头的接触部分呈旋转对称的柱体，柱体不同高度上分布有3个独立的接触区域，分别对应对焦控制、快门控制和地线。
其中两根控制线待机时为带有上拉的输入端口，电压为3.3v。当其与地线短接，从而拉至低电平时，即可触发对应的控制。
此外，当手动按下相机快门按钮时，这些控制线也可输出低电平，以控制其他外设。

\begin{figure}
\centering
\includegraphics[height=2cm]{figures/2.5mm}
\caption{快门线接口的2.5mm插头}
\label{fig:2.5mm}
\end{figure}

\paragraph{被动同步装置设计}
如上所述，若要控制所有相机同时触发快门，则仅需将所有相机的快门控制线连接到同一个按钮上，在按下该按钮时，使控制线和地线短接即可。
但其中设计的难点在于，被控制的相机数量较多，有12台且可能在未来进一步扩展，且相机在空间上较为分散。
因此，为了节约线材，并提升操作的便捷性和装置的可扩展性，本方案设计了一种可串联的相机控制器。
控制器与控制器，控制器与相机间的连接拓扑如图\ref{fig:passive_sync_topo}所示。
\begin{figure}
\centering
\includegraphics[height=5cm]{figures/passive_sync_topo}
\caption{被动同步装置的拓扑结构}
\label{fig:passive_sync_topo}
\end{figure}
控制器间可以任意方式连接，构成星型、树形或链式等多种不同拓扑，每个控制器最多能与3个其他控制器以及8台相机相连。
该结构可通过增加控制器的方式近乎无限扩展，从而实现对更多相机的控制。
此外，每个控制器上都是对等的，通过任意一个控制器上的按钮均可控制所有相机，提升了系统操作的便捷性。

\begin{figure}
\includegraphics[width=\textwidth]{figures/passive_sync_schematic}
\caption{控制器的电路原理图}
\label{fig:passive_sync_schematic}
\end{figure}

\begin{figure}
\centering
\includegraphics[height=5cm]{figures/passive_sync_controller}
\caption{控制器的实物图}
\end{figure}

其中，每个控制器的原理图如图\ref{fig:passive_sync_schematic}所示。
控制器无需供电，它采用机械按钮的形式完成控制线和底线的短接，从而触发相机快门。
控制器之间，以及相机与控制器间均采用AWG28规格的排线连接，
在控制器端均使用了冷压的XH2.54插头；
在相机段则使用了焊接的2.5mm插头。
此外，每个相机接口在连接到总线前均使用了两颗二极管进行隔离，以防止相机间的干扰。
这样可允许在控制器连接时依然可以手动控制单台相机的快门，也能防止在线缆连接时误触发快门。

\paragraph{同步精度测试}

\begin{figure}
\centering
\begin{subfigure}[b]{0.55\textwidth}
    \includegraphics[width=\textwidth]{figures/passive_sync_test}
    \caption{测试过程示意图}
\end{subfigure}%
\begin{subfigure}[b]{0.44\textwidth}
    \includegraphics[width=\textwidth]{figures/LED_array}
    \caption{单片机和LED阵列}
\end{subfigure}%
\caption{被动同步装置的测试装置}
\label{fig:passive_sync_test}
\end{figure}

电场的传播速度非常快，因此，当控制器的按钮被按下时，理论上控制信号能同时送达所有相机。
为了实际测试该装置的效果，本文进行了端到端的同步精度测试。
如图\ref{fig:passive_sync_test}所示，该测试的拍摄目标包括5个由单片机控制的LED灯，以及一个60Hz刷新率的显示器（此处使用iPad）。
其中单片机通过硬件计时器中断精确控制LED灯，每个LED灯的亮灭切换间隔依次为0.5ms、1ms、2ms、4ms、8ms，每16ms这些LED灯的状态完成一次循环。
显示器则显示一个秒表，用于判断16ms以上的时间间隔。

相机拜摆放时，需要使LED灯在不同相机传感器的同一位置成像，以避免滚动快门的影响。
拍摄前，需要将快门速度调整为最快的1/4000秒，以尽量避免相机曝光过程与LED的亮灭切换过程重叠，影响读取LED灯的状态。
测试时，将两台相机连接在控制器上，然后多次使用控制器触发快门。
读取结果时，首先丢弃难以判断LED灯状态的图像，
对剩余图像以二进制编码的形式记录LED灯的状态以及屏幕显示的秒表的时间。
对比同一次快门中不同相机拍摄到的照片中读数即可准确获得两台相机曝光的时间差，即控制器的同步精度。

实验结果显示，多台佳能R6相机间的同步精度小于0.5ms，即每次拍摄中不同相机的读数均相同。该精度已经足够满足实际应用的需求，且已经远高于快门滚动的速度。
此外，本文也测试了R6和另一台佳能90D单反相机间同步的精度，结果显示两台相机间有4ms但非常稳定的延迟。

\input{calib}

\section{基于反射球的光源标定和HDRI合成}

\section{主动相机/闪光灯同步}

主动相机同步装置有单片机等实时控制系统控制，能独立控制每台相机、闪光灯触发延迟，最多24个通道。可用于快速抓拍不同闪光灯照明下的照片

\paragraph{主动同步装置硬件设计}

\paragraph{主动同步装置软件设计}

\paragraph{滚动快门原理}

\paragraph{闪光灯触发延迟快速标定方法}

\section{照片拍摄和整理流程}

\paragraph{同步装置连接与设定}

\paragraph{拍摄采集对象}

\paragraph{相机、光源标定数据采集}

\paragraph{照片拷贝和整理}

\section{初步验证}

作为该实验平台实用性的初步验证，本文利用该平台采集的数据使用传统的计算机视觉方法尝试重建人脸模型。

本文首先使用Colmap完成人脸的稀疏以及稠密点云重建。\TODO{参数调整}

然后，本文使用FlameFitting工具，将FLAME 3D模型配准到稠密点云上，得到初步的人脸几何形状。

然而，该配准的效果并不理想。因此本文使用Blender同时导入点云和几何形状，并手动调整模型顶点位置以完成更精确的配准。

最后，本文通过Unwrap方法，将照片映射到UV空间，每个视角获得一张纹理贴图，再将这些纹理贴图通过以下方式进行融合，最终获得一个带纹理的3D人脸模型。

\TODO{融合方式公式}

\TODO{结果图}

\section{后续工作}

然而，这种方法仅仅是对该平台采集的数据的初步利用，仅发挥了该平台的一小部分价值。
该平台的设计目标是用于运行可微分渲染算法，后续的研究者们将能利用该平台开展诸多基于可微分渲染的研究，例如：
\begin{itemize}
\item 在传统计算机视觉重建的几何形状的基础上，利用可微分渲染算法，实现符合基于物理的渲染(PBR)流程的人脸材质，包括粗糙度、次表面散射等参数。
\item 利用所采集到的HDRI光源信息，基于分离求和近似(split sum approximation)的可微分光栅化渲染算法，直接端到端地同时估计人脸的几何结构和材质。
\item 利用光线追踪方法，进一步考虑全局光照，以估计更加准确的材质。
\item 将本系统所使用的消费级微单相机更换为工业相机，以实现视频帧同步，可将该实验平台扩展为采集人脸动态表情数据。
\end{itemize}
